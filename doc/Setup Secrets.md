# Setup Secrets
This section describes configuring secrets like SSH keys or VPN configurations within the playbook**. Although the secrets will be stored encrypted in the playbook, it is <u>highly recommended</u> not to publish the secrests in a public Git repository.** It is recommend to fork this repository, customize the pre-configured setting and use  the playbook privately for yourself. 

## Setup SSH Keys
**(optional) Step 01 -** Generate SSH keys:

```shell
mkdir -p roles/secrets0/files/ && ssh-keygen -f roles/secrets0/files/example-key -t rsa -b 4096
```

*Key must be <u>only</u> generated, if no SSH hey is available.*

**Step 02 -** Encrypt the SSH keys:
 
```shell
ansible-vault encrypt roles/secrets/files/example-key.pub roles/secrets/files/example-key
```

***During the encryption, Ansible will ask you for vault password. Use the <u>same password you used before</u> for encrypting other files. Otherwise Ansible may will not be able to decrypt every encrypted file during the deployment. Furthermore, the vault password should be stored in password safe (e.g. KeePass, 1Password) and the vault password should be long and complex (ideally generated by an password generator).***

**Step 03 -** Edit the file `kali-default.yml`and make the following changes:

```shell
nano group_vars/kali-default.yml
```

```yml
setup_ssh: yes
ssh_keys:
  - { key: "example-key", mode: '0600'}
  - { key: "example-key.pub", mode: '0644'}
```

*For more information about the variables, refer to [Custom Variables](Custom%20Variables.md).*

**Step 04 -** Now the SSH keys must be deployed: 

```shell
. profiles/kali-default-hosts.profile && make secrets
```

## Setup VPN Configurations
**Step 01 -** Create a new VPN configuration directory:

```shell
mkdir -p roles/secrets/templates/vpn-example
```

*Key must be <u>only</u> generated, if no SSH hey is available.*

**Step 03 -** Move your VPN configuration into the created VPN directory:

```shell
mv /path/to/example-vpn.config.ovpn roles/secrets/templates/vpn-example
```

**Step 03 -** Encrypt the VPN configuration:
 
```shell
ansible-vault encrypt roles/secrets/templates/vpn-example/example-vpn.config.ovpn
```

***During the encryption, Ansible will ask you for vault password. Use the <u>same password you used before</u> for encrypting other files. Otherwise Ansible may will not be able to decrypt every encrypted file during the deployment. Furthermore, the vault password should be stored in password safe (e.g. KeePass, 1Password) and the vault password should be long and complex (ideally generated by an password generator).***

**Step 04-** Edit the file `kali-default.yml`and make the following changes:

```shell
nano group_vars/kali-default.yml
```

```yml
setup_vpn: yes
vpn_configs:
  - { dir: "example", file: "example-vpn.config.ovpn" }
```

*For more information about the variables, refer to [Custom Variables](Custom%20Variables.md).*

**Step 05 -** Now the SSH keys must be deployed: 

```shell
. profiles/kali-default-hosts.profile && make secrets
```

## Decrypt SSH Keys & VPN Configurations
Decrypt example SSH keys:

```shell
ansible-vault decrypt roles/secrets/files/example-key.pub roles/secrets/files/example-key
```

Decrypt example VPN configuration:

```shell
ansible-vault decrypt roles/secrets/templates/vpn-example/example-vpn.config.ovpn
```

## View SSH Keys & VPN Configurations
View example SSH keys:

```shell
ansible-vault view roles/secrets/files/example-key.pub
```

```shell
ansible-vault view roles/secrets/files/example-key
```

View example VPN configuration:

```shell
ansible-vault view roles/secrets/templates/vpn-example/example-vpn.config.ovpn
```

## References
- [Protecting sensitive data with Ansible vault](https://docs.ansible.com/ansible/latest/vault_guide/index.html#protecting-sensitive-data-with-ansible-vault)